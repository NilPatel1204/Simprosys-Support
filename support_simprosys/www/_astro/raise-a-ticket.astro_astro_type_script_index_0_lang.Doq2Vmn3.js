document.addEventListener("DOMContentLoaded",async function(){const e="https://simprosys.frappe.cloud",n="6fe867e53ad492c",l="03189fe2e131e54",a=document.getElementById("plugin_or_app_related_queries"),o=document.getElementById("platformSelect"),s=document.getElementById("appSelect"),p=o.nextElementSibling,y=s.nextElementSibling;function i(){o.style.display="none",s.style.display="none",y.style.display="none",p.style.display="none"}function f(){o.style.display="block",s.style.display="block",y.style.display="flex",p.style.display="flex"}function h(){Array.from(o.options).forEach((t,d)=>{d!==0&&(t.style.display="none")})}async function g(){try{const d=await(await fetch(`${e}/api/resource/Simprosys%20Post%20Category?fields=["name","post_category_name"]&filters=[["category_criteria", "=", "Platform"],["status","=","publish"]]&order_by=\`order\` asc`,{method:"GET",headers:{Authorization:`token ${n}:${l}`}})).json();d.data&&(o.innerHTML+=d.data.map(r=>`<option value="${r.name}">${r.post_category_name}</option>`).join(""),h())}catch(t){console.error("Error fetching platforms:",t)}}async function v(t){if(s.innerHTML='<option value="" disabled selected>Select App</option>',!!t)try{const r=await(await fetch(`${e}/api/resource/Simprosys%20Post%20Category?fields=["name","post_category_name"]&filters=[["category_criteria", "=", "Category"],["parent_simprosys_post_category","=","${t}"],["status","=","publish"]]&order_by=\`order\` asc`,{method:"GET",headers:{Authorization:`token ${n}:${l}`}})).json();r.data&&(s.innerHTML+=r.data.map(_=>`<option value="${_.name}">${_.post_category_name}</option>`).join(""))}catch(d){console.error("Error fetching apps:",d)}}a.addEventListener("change",function(){const t=this.value;t==="Plugin and App related query"?f():i(),Array.from(o.options).forEach((d,r)=>{r!==0&&(d.style.display=t?"block":"none")})}),o.addEventListener("change",t=>{v(t.target.value),o.querySelector("option[value='']").disabled=!0}),s.addEventListener("change",()=>{s.querySelector("option[value='']").disabled=!0}),g(),i()});const F=document.getElementById("name1"),q=document.getElementById("company_name"),M=document.getElementById("email");let c=document.getElementById("name1_valid"),u=document.getElementById("company_valid"),m=document.getElementById("email_valid");const w=/^(?=(?:[^A-Za-z]*[A-Za-z]){2})(?![^\d~`?!^*¨ˆ;@=$%{}\[\]|\\\/<>#“.,]*[\d~`?!^*¨ˆ;@=$%{}\[\]|\\\/<>#“.,])\S+(?: \S+){0,2}$/,H=/^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$/,N=/[a-zA-Z0-9-]+(\.[a-zA-Z]{2,})+([\/\w.-]*)*\/?/;let A=!1,P=!1,$=!1,R=!1,I=!1,L=!1,x=!1,B=!0;F.addEventListener("input",()=>{const e=F.value.trim();e===""?(c.classList.remove("hidden"),c.textContent="Please fill out this field"):w.test(e)?(c.classList.add("hidden"),c.textContent=""):(c.classList.remove("hidden"),c.textContent="Please Enter Valid name")});q.addEventListener("input",()=>{const e=q.value.trim();e===""?(u.classList.remove("hidden"),u.textContent="Please fill out this field"):w.test(e)?(u.classList.add("hidden"),u.textContent=""):(u.classList.remove("hidden"),u.textContent="Please Enter Valid Company name")});M.addEventListener("input",()=>{const e=M.value.trim();e===""?(m.classList.remove("hidden"),m.textContent="Please fill out this field"):H.test(e)?(m.classList.add("hidden"),m.textContent=""):(m.classList.remove("hidden"),m.textContent="Please Enter Valid Email")});const b=document.getElementById("store_url"),C=document.getElementById("store_url_valid");b.addEventListener("input",function(){const e=b.value.trim();e===""||N.test(e)?C.classList.add("hidden"):(C.classList.remove("hidden"),B=!1)});const S=document.getElementById("plugin_or_app_related_queries"),D=document.getElementById("platformSelect"),j=document.getElementById("appSelect"),T=document.getElementById("plugin_id_valid"),V=document.getElementById("platform_id_valid"),k=document.getElementById("app_id_valid");j.addEventListener("input",()=>{S.value==="Plugin and App related query"&&j.value===""?(k.classList.remove("hidden"),x=!1):(k.classList.add("hidden"),x=!0)});D.addEventListener("input",()=>{S.value==="Plugin and App related query"&&D.value===""?(V.classList.remove("hidden"),L=!1):(V.classList.add("hidden"),L=!0)});S.addEventListener("input",()=>{S.value===""?(T.classList.remove("hidden"),I=!1):(T.classList.add("hidden"),I=!0)});function O(){let e=F.value.trim(),n=q.value.trim(),l=M.value.trim();if(e===""?(c.classList.remove("hidden"),c.textContent="Please fill out this field",A=!1):w.test(e)?(c.classList.add("hidden"),c.textContent="",A=!0):(c.classList.remove("hidden"),c.textContent="Please Enter Valid name",A=!1),n===""?(u.classList.remove("hidden"),u.textContent="Please fill out this field",P=!1):w.test(n)?(u.classList.add("hidden"),u.textContent="",P=!0):(u.classList.remove("hidden"),u.textContent="Please Enter Valid Company name",P=!1),l===""?(m.classList.remove("hidden"),m.textContent="Please fill out this field",$=!1):H.test(l)?(m.classList.add("hidden"),m.textContent="",$=!0):(m.classList.remove("hidden"),m.textContent="Please Enter Valid Email",$=!1),S.value===""?(T.classList.remove("hidden"),I=!1):(T.classList.add("hidden"),I=!0),S.value==="Plugin and App related query"?(D.value===""?(V.classList.remove("hidden"),L=!1):(V.classList.add("hidden"),L=!0),j.value===""?(k.classList.remove("hidden"),x=!1):(k.classList.add("hidden"),x=!0)):(L=!0,x=!0),b!==null){const a=b.value.trim();a===""||N.test(a)?(C.classList.add("hidden"),B=!0):(C.classList.remove("hidden"),B=!1)}return A&&P&&$&&I&&L&&x&&z&&B&&(R=!0),R}let z=!0,E=[];document.getElementById("attach_file").addEventListener("change",function(e){let n=e.target.files,l=document.getElementById("file_error"),a=document.getElementById("file_list"),o=document.getElementById("attach_file_text"),s=["jpeg","jpg","png","pdf","txt","zip","zzip","mp4","docx","csv","webp"],p=0,y=[],i=[];a.innerHTML="";for(let t=0;t<n.length;t++){let d=n[t].name.split(".").pop().toLowerCase();s.includes(d)?E.push(n[t]):i.push(n[t].name)}if(i.length>0){l.textContent=`Invalid file types: ${i.join(", ")}. Allowed formats: ${s.join(", ")}`,e.target.value="";return}else l.textContent="";E.forEach(t=>{p+=t.size,y.push(t.name)});let f=25;if(p/(1024*1024)>f){l.textContent=`Total file size must be under ${f}MB.`,e.target.value="",E=[],z=!1,o.textContent="Attach File";return}else l.textContent="",z=!0;function g(t){E.splice(t,1),v()}function v(){a.innerHTML="",E.forEach((t,d)=>{let r=document.createElement("div");r.classList.add("file-item"),r.textContent=t.name;let _=document.createElement("button");_.textContent="x",_.classList.add("cancel-btn"),_.addEventListener("click",function(){g(d)}),r.appendChild(_),a.appendChild(r)})}v()});document.getElementById("cancel_file").addEventListener("click",function(){let e=document.getElementById("attach_file"),n=document.getElementById("file_list");e.value="",n.innerHTML="",document.getElementById("file_error").textContent="",E=[],z=!0});document.getElementById("form_id");function U(e){const n=document.getElementById("success-popup"),l=document.getElementById("form_id");let a=document.getElementById("cancel_file");e.ok?(n.classList.remove("hidden"),console.log("Ticket created successfully."),document.getElementById("closePopup").addEventListener("click",()=>{n.classList.add("hidden"),a.classList.add("hidden"),document.getElementById("attach_file_text").textContent="Attach File",document.getElementById("file_list").innerHTML="",l.reset()}),setTimeout(()=>{n.classList.add("hidden"),a.classList.add("hidden"),document.getElementById("attach_file_text").textContent="Attach File",document.getElementById("file_list").innerHTML="",l.reset()},3e3),e.status===100?(n.classList.remove("hidden"),console.log("Document created successfully.")):console.error("Failed to create document.")):console.error("Failed to create document.")}async function Z(e){if(e.preventDefault(),O()){const l="https://simprosys.frappe.cloud",a="6fe867e53ad492c",o="03189fe2e131e54",s=document.querySelector("#attach_file");let p=[];if(s.files.length>0)for(let i=0;i<s.files.length;i++){const f=s.files[i],h=new FormData;h.append("file",f),h.append("is_private",0);try{const g=await fetch(`${l}/api/method/upload_file`,{method:"POST",headers:{Authorization:`token ${a}:${o}`},body:h}),v=await g.json();if(g.ok&&v.message.file_url)p.push(v.message.file_url);else{alert("File upload failed: "+(v.message.error||"Unknown error"));return}}catch(g){console.error("File upload error:",g),alert("File upload failed!");return}}const y={name1:document.querySelector("#name1").value,company_name:document.querySelector("#company_name").value,store_url:document.querySelector("#store_url").value,email:document.querySelector("#email").value,plugin_or_app_related_queries:document.querySelector("#plugin_or_app_related_queries").value,platform:document.querySelector("#platformSelect").value,app:document.querySelector("#appSelect").value,additional_details:document.querySelector("#message").value};try{const i=await fetch(`${l}/api/resource/Support%20Simprosys%20Ticket`,{method:"POST",headers:{Authorization:`token ${a}:${o}`,"Content-Type":"application/json"},body:JSON.stringify(y)}),f=await i.json();if(i.ok){let h=f.data.name;await K(h,p),U(i)}else alert("Error: "+f.error)}catch(i){console.error("Form submission error:",i),alert("Failed to submit ticket!")}}}async function K(e,n){const l="https://simprosys.frappe.cloud",a="6fe867e53ad492c",o="03189fe2e131e54";for(let s of n){const p={file_url:s,attached_to_doctype:"Support Simprosys Ticket",attached_to_name:e};try{await fetch(`${l}/api/resource/File`,{method:"POST",headers:{Authorization:`token ${a}:${o}`,"Content-Type":"application/json"},body:JSON.stringify(p)})}catch(y){console.error("Attachment error:",y)}}}window.submitTicket=Z;
