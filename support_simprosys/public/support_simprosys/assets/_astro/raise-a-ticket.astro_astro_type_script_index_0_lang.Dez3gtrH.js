document.addEventListener("DOMContentLoaded",async function(){const e="https://simprosys.frappe.cloud",n="6fe867e53ad492c",a="03189fe2e131e54",i=document.getElementById("plugin_or_app_related_queries"),d=document.getElementById("platformSelect"),o=document.getElementById("appSelect"),f=d.nextElementSibling,y=o.nextElementSibling;function h(){d.style.display="none",o.style.display="none",y.style.display="none",f.style.display="none"}function g(){d.style.display="block",o.style.display="block",y.style.display="flex",f.style.display="flex"}function S(){Array.from(d.options).forEach((t,l)=>{l!==0&&(t.style.display="none")})}async function C(){try{const l=await(await fetch(`${e}/api/resource/Simprosys%20Post%20Category?fields=["name","post_category_name"]&filters=[["category_criteria", "=", "Platform"],["status","=","publish"]]&order_by=\`order\` asc`,{method:"GET",headers:{Authorization:`token ${n}:${a}`}})).json();l.data&&(d.innerHTML+=l.data.map(s=>`<option value="${s.name}" data-display-name="${s.post_category_name}">${s.post_category_name}</option>`).join(""),S())}catch(t){console.error("Error fetching platforms:",t)}}async function r(t){if(o.innerHTML='<option value="" disabled selected>Select App</option>',!!t)try{const s=await(await fetch(`${e}/api/resource/Simprosys%20Post%20Category?fields=["name","post_category_name"]&filters=[["category_criteria", "=", "Category"],["parent_simprosys_post_category","=","${t}"],["status","=","publish"]]&order_by=\`order\` asc`,{method:"GET",headers:{Authorization:`token ${n}:${a}`}})).json();s.data&&(o.innerHTML+=s.data.map(c=>`<option value="${c.name}" data-display-name="${c.post_category_name}">${c.post_category_name}</option>`).join(""))}catch(l){console.error("Error fetching apps:",l)}}i.addEventListener("change",function(){const t=this.value;t==="Plugin and App related query"?g():h(),Array.from(d.options).forEach((l,s)=>{s!==0&&(l.style.display=t?"block":"none")})}),d.addEventListener("change",t=>{r(t.target.value),d.querySelector("option[value='']").disabled=!0}),o.addEventListener("change",()=>{o.querySelector("option[value='']").disabled=!0}),C(),h()});const F=document.getElementById("name1"),q=document.getElementById("company_name"),M=document.getElementById("email");let u=document.getElementById("name1_valid"),m=document.getElementById("company_valid"),p=document.getElementById("email_valid");const b=/^(?=(?:[^A-Za-z]*[A-Za-z]){2})(?![^\d~`?!^*¨ˆ;@=$%{}\[\]|\\\/<>#“.,]*[\d~`?!^*¨ˆ;@=$%{}\[\]|\\\/<>#“.,])\S+(?: \S+){0,2}$/,H=/^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$/,N=/[a-zA-Z0-9-]+(\.[a-zA-Z]{2,})+([\/\w.-]*)*\/?/;let A=!1,P=!1,$=!1,R=!1,B=!1,v=!1,E=!1,I=!0;F.addEventListener("input",()=>{const e=F.value.trim();e===""?(u.classList.remove("hidden"),u.textContent="Please fill out this field"):b.test(e)?(u.classList.add("hidden"),u.textContent=""):(u.classList.remove("hidden"),u.textContent="Please Enter Valid name")});q.addEventListener("input",()=>{const e=q.value.trim();e===""?(m.classList.remove("hidden"),m.textContent="Please fill out this field"):b.test(e)?(m.classList.add("hidden"),m.textContent=""):(m.classList.remove("hidden"),m.textContent="Please Enter Valid Company name")});M.addEventListener("input",()=>{const e=M.value.trim();e===""?(p.classList.remove("hidden"),p.textContent="Please fill out this field"):H.test(e)?(p.classList.add("hidden"),p.textContent=""):(p.classList.remove("hidden"),p.textContent="Please Enter Valid Email")});const w=document.getElementById("store_url"),L=document.getElementById("store_url_valid");w.addEventListener("input",function(){const e=w.value.trim();e===""||N.test(e)?L.classList.add("hidden"):(L.classList.remove("hidden"),I=!1)});const x=document.getElementById("plugin_or_app_related_queries"),D=document.getElementById("platformSelect"),j=document.getElementById("appSelect"),T=document.getElementById("plugin_id_valid"),V=document.getElementById("platform_id_valid"),k=document.getElementById("app_id_valid");j.addEventListener("input",()=>{x.value==="Plugin and App related query"&&j.value===""?(k.classList.remove("hidden"),E=!1):(k.classList.add("hidden"),E=!0)});D.addEventListener("input",()=>{x.value==="Plugin and App related query"&&D.value===""?(V.classList.remove("hidden"),v=!1):(V.classList.add("hidden"),v=!0)});x.addEventListener("input",()=>{x.value===""?(T.classList.remove("hidden"),B=!1):(T.classList.add("hidden"),B=!0)});function O(){let e=F.value.trim(),n=q.value.trim(),a=M.value.trim();if(e===""?(u.classList.remove("hidden"),u.textContent="Please fill out this field",A=!1):b.test(e)?(u.classList.add("hidden"),u.textContent="",A=!0):(u.classList.remove("hidden"),u.textContent="Please Enter Valid name",A=!1),n===""?(m.classList.remove("hidden"),m.textContent="Please fill out this field",P=!1):b.test(n)?(m.classList.add("hidden"),m.textContent="",P=!0):(m.classList.remove("hidden"),m.textContent="Please Enter Valid Company name",P=!1),a===""?(p.classList.remove("hidden"),p.textContent="Please fill out this field",$=!1):H.test(a)?(p.classList.add("hidden"),p.textContent="",$=!0):(p.classList.remove("hidden"),p.textContent="Please Enter Valid Email",$=!1),x.value===""?(T.classList.remove("hidden"),B=!1):(T.classList.add("hidden"),B=!0),x.value==="Plugin and App related query"?(D.value===""?(V.classList.remove("hidden"),v=!1):(V.classList.add("hidden"),v=!0),j.value===""?(k.classList.remove("hidden"),E=!1):(k.classList.add("hidden"),E=!0)):(v=!0,E=!0),w!==null){const i=w.value.trim();i===""||N.test(i)?(L.classList.add("hidden"),I=!0):(L.classList.remove("hidden"),I=!1)}return A&&P&&$&&B&&v&&E&&z&&I&&(R=!0),R}let z=!0,_=[];document.getElementById("attach_file").addEventListener("change",function(e){let n=e.target.files,a=document.getElementById("file_error"),i=document.getElementById("file_list"),d=document.getElementById("attach_file_text"),o=["jpeg","jpg","png","pdf","txt","zip","zzip","mp4","docx","csv","webp"],f=0,y=[],h=[];i.innerHTML="";for(let t=0;t<n.length;t++){let l=n[t].name.split(".").pop().toLowerCase();o.includes(l)?_.push(n[t]):h.push(n[t].name)}if(h.length>0){a.textContent=`Invalid file types: ${h.join(", ")}. Allowed formats: ${o.join(", ")}`,e.target.value="";return}else a.textContent="";_.forEach(t=>{f+=t.size,y.push(t.name)});let g=25;if(f/(1024*1024)>g){a.textContent=`Total file size must be under ${g}MB.`,e.target.value="",_=[],z=!1,d.textContent="Attach File";return}else a.textContent="",z=!0;function C(t){_.splice(t,1),r()}function r(){i.innerHTML="",_.forEach((t,l)=>{let s=document.createElement("div");s.classList.add("file-item"),s.textContent=t.name;let c=document.createElement("button");c.textContent="x",c.classList.add("cancel-btn"),c.addEventListener("click",function(){C(l)}),s.appendChild(c),i.appendChild(s)})}r()});document.getElementById("cancel_file").addEventListener("click",function(){let e=document.getElementById("attach_file"),n=document.getElementById("file_list");e.value="",n.innerHTML="",document.getElementById("file_error").textContent="",_=[],z=!0});document.getElementById("form_id");function U(e){const n=document.getElementById("success-popup"),a=document.getElementById("form_id");let i=document.getElementById("cancel_file");e.ok?(n.classList.remove("hidden"),console.log("Ticket created successfully."),document.getElementById("closePopup").addEventListener("click",()=>{n.classList.add("hidden"),i.classList.add("hidden"),document.getElementById("attach_file_text").textContent="Attach File",document.getElementById("file_list").innerHTML="",a.reset()}),setTimeout(()=>{n.classList.add("hidden"),i.classList.add("hidden"),document.getElementById("attach_file_text").textContent="Attach File",document.getElementById("file_list").innerHTML="",a.reset()},3e3),e.status===100?(n.classList.remove("hidden"),console.log("Document created successfully.")):console.error("Failed to create document.")):console.error("Failed to create document.")}async function Z(e){if(e.preventDefault(),O()){const a="https://simprosys.frappe.cloud",i="6fe867e53ad492c",d="03189fe2e131e54",o=document.querySelector("#attach_file");let f=[];if(o.files.length>0)for(let r=0;r<o.files.length;r++){const t=o.files[r],l=new FormData;l.append("file",t),l.append("is_private",0);try{const s=await fetch(`${a}/api/method/upload_file`,{method:"POST",headers:{Authorization:`token ${i}:${d}`},body:l}),c=await s.json();if(s.ok&&c.message.file_url)f.push(c.message.file_url);else{alert("File upload failed: "+(c.message.error||"Unknown error"));return}}catch(s){console.error("File upload error:",s),alert("File upload failed!");return}}const y=document.querySelector("#platformSelect"),h=document.querySelector("#appSelect"),g=y.options[y.selectedIndex],S=h.options[h.selectedIndex],C={name1:document.querySelector("#name1").value,company_name:document.querySelector("#company_name").value,store_url:document.querySelector("#store_url").value,email:document.querySelector("#email").value,plugin_or_app_related_queries:document.querySelector("#plugin_or_app_related_queries").value,platform:g?g.getAttribute("data-display-name"):"",app:S?S.getAttribute("data-display-name"):"",additional_details:document.querySelector("#message").value};try{const r=await fetch(`${a}/api/resource/Support%20Simprosys%20Ticket`,{method:"POST",headers:{Authorization:`token ${i}:${d}`,"Content-Type":"application/json"},body:JSON.stringify(C)}),t=await r.json();if(r.ok){let l=t.data.name;await K(l,f),U(r)}else alert("Error: "+t.error)}catch(r){console.error("Form submission error:",r),alert("Failed to submit ticket!")}}}async function K(e,n){const a="https://simprosys.frappe.cloud",i="6fe867e53ad492c",d="03189fe2e131e54";for(let o of n){const f={file_url:o,attached_to_doctype:"Support Simprosys Ticket",attached_to_name:e};try{await fetch(`${a}/api/resource/File`,{method:"POST",headers:{Authorization:`token ${i}:${d}`,"Content-Type":"application/json"},body:JSON.stringify(f)})}catch(y){console.error("Attachment error:",y)}}}window.submitTicket=Z;
